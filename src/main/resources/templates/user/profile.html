<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/profile.css}">
    <title>Metaway MyPage</title>
</head>

<body>
    <header th:replace="~{/include/header.html}"></header>
    <div class="container">
        <div class="profile-nav">
            <nav class="profile-nav-ul">
                <ul>
					<!--<li class="profile-nav-p" ><a th:href="@{/user/profile}">마이페이지</a></li>-->
                    <li class="profile-nav-p" id="xhrButton0">마이페이지</li>
                    <li id="xhrButton">구매 내역</li>
                    <!--구매 취소 내역 / 환불 내역-->
                    <li><a th:href="@{/return}">반납 내역</a></li>
                    <!--반납 신청 내역 / 반납 환불 내역-->
                    <li><a th:href="@{/contract}">약정 내역</a></li>
                    <!--약정 연장 내역 / 약정 해지 내역-->
                </ul>
            </nav>
        </div>
        <div class="profile-page">
            <div class="user-info" th:if="${userProfile != null}" id="userInfoSection">
                <span th:text="${userProfile.name + '님의 프로필'}" class="text-highlight"></span>

                <p>Account:<span th:text="${userProfile.account}"></span></p>
                <p>Email: <span th:text="${userProfile.email}"></span></p>
                <p>Name: <span th:text="${userProfile.name}"></span></p>
                <p>Phone: <span th:text="${userProfile.phone}"></span></p>
                <p>Age: <span th:text="${userProfile.age}"></span></p>
                <p>Address: <span th:text="${userProfile.address}"></span></p>

                <button class="pwd-btn" id="btn-modal1">비밀번호 변경</button>
                <button class="pwd-btn" id="btn-modal2">회원 탈퇴</button>
            </div>
            <div id="modal1" class="modal-overlay">
                <div class="modal-window">
                    <div class="close-area">X</div>
                    <div class="content">
                        <p>비밀번호 변경</p>
                        <p class="warning-message">새로운 비밀번호를 입력해 주세요. <br>타인에게 비밀번호가 노출되지 않도록 주의해
                            주세요.</p>
                    </div>
                    <form th:action="@{/user/changepassword}" method="post">
                        <input type="password" name="password" placeholder="new password" required autocomplete="new-password" />
                        <button type="submit"><span>변경</span></button>
                    </form>
                </div>
            </div>
            <div id="modal2" class="modal-overlay">
                <div class="modal-window">
                    <div class="close-area">X</div>
                    <div class="content">
                        <p>회원 탈퇴</p>
                        <p class="warning-message">그 동안 메타웨이 서비스를 이용해 주셔서 감사합니다. <br>고객님께 더 나은
                            서비스를 제공해 드리기 위해 노력하겠습니다.</p>
                        <form th:action="@{/user/delete}" method="post">
                            <input type="password" name="password" placeholder="your password" required />
                            <button type="submit">탈퇴</button>
                        </form>
                    </div>
                </div>
            </div>
            <div th:unless="${userProfile != null}">
                <p>User profile not available.</p>
            </div>
            
            <div id="orderDetailsTable" style="display: none;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">번호</th>
                            <th scope="col">주문번호</th>
                            <th scope="col">주문자</th>
                            <th scope="col">상품번호</th>
                            <th scope="col">계약 ID?</th>
                            <th scope="col">수량</th>
                            <th scope="col">설치시작</th>
                            <th scope="col">설치완료</th>
                            <th scope="col">모델명</th>
                            <th scope="col">주문가격</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="orderDetail : ${orderList}">
                            <td th:text="${orderDetail.index + 1}"></td>
                            <td th:text="${orderDetail.orderDetailId}"></td>
                            <td th:text="${orderDetail.orderId}"></td>
                            <td th:text="${orderDetail.productId}"></td>
                            <td th:text="${orderDetail.contractId}"></td>
                            <td th:text="${orderDetail.orderCount}"></td>
                            <td th:text="${orderDetail.startDate}"></td>
                            <td th:text="${orderDetail.endDate}"></td>
                            <td th:text="${orderDetail.productModel}"></td>
                            <td th:text="${orderDetail.orderPrice}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>   
        </div>
    </div>
    <footer th:replace="~{/include/footer.html}"></footer>
        <script>
document.addEventListener("DOMContentLoaded", function () {
    // 모달 관련 요소
	    const modal = document.getElementById("modal1");
	    
	
	    // 사용자 정보 섹션 요소
	    const userInfoSection = document.getElementById("userInfoSection");
	    const profilePage = document.getElementById("profilePage");
	
	    // 주문 정보 테이블 및 버튼 관련 요소
	    const orderDetailsTable = document.getElementById("orderDetailsTable");
	    const xhrButton = document.getElementById("xhrButton");
	    const xhrButton0 = document.getElementById("xhrButton0");
	
	    // 모달을 열고 닫는 함수들
	    function modalOn() {
            modal.style.display = "flex"
        }

        function isModalOn() {
            return modal.style.display === "flex"
        }

        function modalOff() {
            modal.style.display = "none"
        }

        const btnModal = document.getElementById("btn-modal1")
        btnModal.addEventListener("click", e => {
            modalOn()
        })

        const closeBtn = modal.querySelector(".close-area")
        closeBtn.addEventListener("click", e => {
            modalOff()
        })

        modal.addEventListener("click", e => {
            const evTarget = e.target
            if (evTarget.classList.contains("modal-overlay")) {
                modalOff()
            }
        })

        window.addEventListener("keyup", e => {
            if (isModalOn() && e.key === "Escape") {
                modalOff()
            }
        })

        const modal2 = document.getElementById("modal2");

        function modalOn2() {
            modal2.style.display = "flex";
        }

        function isModalOn2() {
            return modal2.style.display === "flex";
        }

        function modalOff2() {
            modal2.style.display = "none";
        }

        const btnModal2 = document.getElementById("btn-modal2");
        btnModal2.addEventListener("click", e => {
            modalOn2();
        });

        const closeBtn2 = modal2.querySelector(".close-area");
        closeBtn2.addEventListener("click", e => {
            modalOff2();
        });

        modal2.addEventListener("click", e => {
            const evTarget = e.target;
            if (evTarget.classList.contains("modal-overlay")) {
                modalOff2();
            }
        });

        window.addEventListener("keyup", e => {
            if (isModalOn2() && e.key === "Escape") {
                modalOff2();
            }
        });
	
	    // 사용자 정보 섹션을 보여주는 함수
			function showUserInfoSection(userProfile) {
			    // 사용자 정보 업데이트
			    var textHighlight = document.querySelector(".text-highlight");
			    var accountSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.account}']");
			    var emailSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.email}']");
			    var nameSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.name}']");
			    var phoneSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.phone}']");
			    var ageSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.age}']");
			    var addressSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.address}']");
			
			    if (textHighlight && accountSpan && emailSpan && nameSpan && phoneSpan && ageSpan && addressSpan) {
			        textHighlight.innerText = userProfile.name + '님의 프로필';
			        accountSpan.innerText = userProfile.account;
			        emailSpan.innerText = userProfile.email;
			        nameSpan.innerText = userProfile.name;
			        phoneSpan.innerText = userProfile.phone;
			        ageSpan.innerText = userProfile.age;
			        addressSpan.innerText = userProfile.address;
			    } else {
			        console.error("One or more elements not found.");
			    }
			}



	
	    // 주문 정보 테이블을 보여주는 함수
	    function showOrderDetailsTable(orderList) {
	        console.log("Table Shown!");
	        createTable(orderList);
	        orderDetailsTable.style.display = "block";
	        userInfoSection.style.display = "none";
	    }
	
	    // 주문 정보 테이블을 생성하는 함수
	    function createTable(orderList) {
	        var table = '<table class="table table-hover">' +
	            '<thead>' +
	            '<tr>' +
	            '<th scope="col">번호</th>' +
	            '<th scope="col">주문번호</th>' +
	            '<th scope="col">주문자</th>' +
	            '<th scope="col">상품번호</th>' +
	            '<th scope="col">계약 ID?</th>' +
	            '<th scope="col">수량</th>' +
	            '<th scope="col">설치시작</th>' +
	            '<th scope="col">설치완료</th>' +
	            '<th scope="col">모델명</th>' +
	            '<th scope="col">주문가격</th>' +
	            '</tr>' +
	            '</thead>' +
	            '<tbody>';
	
	        for (var i = 0; i < orderList.length; i++) {
	            table += '<tr>' +
	                '<td>' + (i + 1) + '</td>' +
	                '<td>' + orderList[i].orderDetailId + '</td>' +
	                '<td>' + orderList[i].orderId + '</td>' +
	                '<td>' + orderList[i].productId + '</td>' +
	                '<td>' + orderList[i].contractId + '</td>' +
	                '<td>' + orderList[i].orderCount + '</td>' +
	                '<td>' + orderList[i].startDate + '</td>' +
	                '<td>' + orderList[i].endDate + '</td>' +
	                '<td>' + orderList[i].productModel + '</td>' +
	                '<td>' + orderList[i].orderPrice + '</td>' +
	                '</tr>';
	        }
	
	        table += '</tbody></table>';
	
	        orderDetailsTable.innerHTML = table;
	    }
	
	    // xhrButton 클릭 이벤트 핸들러
	    xhrButton.addEventListener("click", function () {
	        $.ajax({
	            url: "/user/orderdetail",
	            type: "GET",
	            dataType: "json",
	            success: function (orderList) {
	                showOrderDetailsTable(orderList);
	            },
	            error: function (xhr, status, error) {
	                console.error("Error fetching order details:", error);
	            }
	        });
	    });

			// xhrButton0 클릭 이벤트 핸들러
			xhrButton0.addEventListener("click", function () {
			    console.log("xhrButton0 clicked");
			
			    $.ajax({
			        url: "/user/profileList",
			        type: "GET",
			        dataType: "json",
			        success: function (userProfile) {
			            console.log("Success fetching user info:", userProfile);
			
			            if (userProfile != null) {
			                // 사용자 정보 업데이트
			                console.log("Updating user info");
			                showUserInfoSection(userProfile);
			
			                // 프로필 페이지 보이기
			                console.log("Showing profile page");
			                userInfoSection.style.display = "block"; // userInfoSection을 보여주도록 수정
			                orderDetailsTable.style.display = "none";
			            } else {
			                console.error("Failed to fetch user info");
			            }
			        },
			        error: function (xhr, status, error) {
			            console.error("Error fetching user info:", error);
			        }
			    });
			});


		});

    </script>

</body>

</html>
