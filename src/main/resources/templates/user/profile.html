<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <link rel="stylesheet" th:href="@{/css/footer.css}">
    <link rel="stylesheet" th:href="@{/css/profile.css}">
    <title>Metaway MyPage</title>
</head>

<body>
    <header th:replace="~{/include/header.html}"></header>
    <div class="container">
        <div class="profile-nav">
            <nav class="profile-nav-ul">
                <ul>
					<!--<li class="profile-nav-p" ><a th:href="@{/user/profile}">마이페이지</a></li>-->
                    <li class="profile-nav-p" id="xhrButton0">마이페이지</li>
                    <li id="xhrButton" onclick="updateOrderList()">구매 내역</li>
                    <!--구매 취소 내역 / 환불 내역-->
                    <li  id="xhrButton1">반납 내역</li>
                    <!--반납 신청 내역 / 반납 환불 내역-->
                    <li><a th:href="@{/contract}">약정 내역</a></li>
                    <!--약정 연장 내역 / 약정 해지 내역-->
                </ul>
            </nav>
        </div>
        <div class="profile-page">
            <div class="user-info" th:if="${userProfile != null}" id="userInfoSection">
                <span th:text="${userProfile.name + '님의 프로필'}" class="text-highlight"></span>

                <p>Account:<span th:text="${userProfile.account}"></span></p>
                <p>Email: <span th:text="${userProfile.email}"></span></p>
                <p>Name: <span th:text="${userProfile.name}"></span></p>
                <p>Phone: <span th:text="${userProfile.phone}"></span></p>
                <p>Age: <span th:text="${userProfile.age}"></span></p>
                <p>Address: <span th:text="${userProfile.address}"></span></p>

                <button class="pwd-btn" id="btn-modal1">비밀번호 변경</button>
                <button class="pwd-btn" id="btn-modal2">회원 탈퇴</button>
            </div>
            <div id="modal1" class="modal-overlay">
                <div class="modal-window">
                    <div class="close-area">X</div>
                    <div class="content">
                        <p>비밀번호 변경</p>
                        <p class="warning-message">새로운 비밀번호를 입력해 주세요. <br>타인에게 비밀번호가 노출되지 않도록 주의해
                            주세요.</p>
                    </div>
                    <form th:action="@{/user/changepassword}" method="post">
                        <input type="password" name="password" placeholder="new password" required autocomplete="new-password" />
                        <button type="submit"><span>변경</span></button>
                    </form>
                </div>
            </div>
            <div id="modal2" class="modal-overlay">
                <div class="modal-window">
                    <div class="close-area">X</div>
                    <div class="content">
                        <p>회원 탈퇴</p>
                        <p class="warning-message">그 동안 메타웨이 서비스를 이용해 주셔서 감사합니다. <br>고객님께 더 나은
                            서비스를 제공해 드리기 위해 노력하겠습니다.</p>
                        <form th:action="@{/user/delete}" method="post">
                            <input type="password" name="password" placeholder="your password" required />
                            <button type="submit">탈퇴</button>
                        </form>
                    </div>
                </div>
            </div>
            <div th:unless="${userProfile != null}">
                <p>User profile not available.</p>
            </div>
            <!--
				
            <div id="orderDetailsTable" style="display: none;">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th scope="col">번호</th>
                            <th scope="col">주문번호</th>
                            <th scope="col">주문자</th>
                            <th scope="col">상품번호</th>
                            <th scope="col">계약 ID?</th>
                            <th scope="col">수량</th>
                            <th scope="col">설치시작</th>
                            <th scope="col">설치완료</th>
                            <th scope="col">모델명</th>
                            <th scope="col">주문가격</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="orderDetail : ${orderList}">
                            <td th:text="${orderDetail.index + 1}"></td>
                            <td th:text="${orderDetail.orderDetailId}"></td>
                            <td th:text="${orderDetail.orderId}"></td>
                            <td th:text="${orderDetail.productId}"></td>
                            <td th:text="${orderDetail.contractId}"></td>
                            <td th:text="${orderDetail.orderCount}"></td>
                            <td th:text="${orderDetail.startDate}"></td>
                            <td th:text="${orderDetail.endDate}"></td>
                            <td th:text="${orderDetail.productModel}"></td>
                            <td th:text="${orderDetail.orderPrice}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>  
            
			-->
            
            	<div id="orderWrap">
				<div class="orderDiv" th:each="order, orderIndex : ${orderList}" th:if="${orderIndex.index < 5}">
					<div class="getOrderDetailBox">
						<div th:text="${order.orderDate} + ' 주문'" class="orderDateBox"></div>
					</div>
					<div class="orderDetailDiv">
						<div th:each="cont, contIndex : ${order.contractList}" th:if="${contIndex.index < 1}"
							class="detailBox">
							<div class="ProductImageBox">
								<div th:if="${order.orderState == 0}" class="stateText">주문 완료</div>
								<div th:if="${order.orderState == 1}" class="stateText">배송 예정</div>
								<div th:if="${order.orderState == 2}" class="stateText">주문 취소</div>
								<div th:if="${order.orderState == 3}" class="stateText">배송 완료</div>
								<div class="orderDetailInfoDiv">
									<img th:src="'data:' + ${cont.product.imageType} + ';base64,' + ${cont.product.imageFile}"
										alt="productImage" class="productImage">
									<div class="productText">
										<div th:text="${cont.product.productModel}" class="ModelClass"></div>
										<div th:if="${order.orderSize != 0}"
											th:text="${cont.product.productName} + ' 외 ' + ${order.orderSize}"
											class="modelName"></div>
										<div th:if="${order.orderSize == 0}" th:text="${cont.product.productName}"
											class="modelName"></div>
										<hr>
										<div th:if="${order.orderPrice} != 0">총 결제액 : <span
												th:text="${order.orderPrice} + '원'" class="spanText"></span></div>
										<div th:if="${order.rentalPrice} != 0">월 렌탈료 : <span
												th:text="'월 ' + ${order.rentalPrice} + '원'" class="spanText"></span>
										</div>
									</div>
								</div>
							</div>
							<div class="rightBox">
								<div class="rightDetailButtonDiv">
									<form method="get" th:action="@{/user/orderDetail}">
										<input type="hidden" th:value="${order.orderId}" name="orderId">
										<button class="orderDetailButton">주문 상세조회</button>
									</form>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
             
             
             
        </div>
    </div>
    <footer th:replace="~{/include/footer.html}"></footer>
        <script>
document.addEventListener("DOMContentLoaded", function () {
    // 모달 관련 요소
	    const modal = document.getElementById("modal1");
            const userInfoSection = document.getElementById("userInfoSection");
            const orderDetailsTable = document.getElementById("orderDetailsTable"); // 주석 처리된 부분 사용 시 필요
            const xhrButton = document.getElementById("xhrButton");
            const xhrButton0 = document.getElementById("xhrButton0");
	
	    // 모달을 열고 닫는 함수들
	    function modalOn() {
            modal.style.display = "flex"
        }

        function isModalOn() {
            return modal.style.display === "flex"
        }

        function modalOff() {
            modal.style.display = "none"
        }

        const btnModal = document.getElementById("btn-modal1")
        btnModal.addEventListener("click", e => {
            modalOn()
        })

        const closeBtn = modal.querySelector(".close-area")
        closeBtn.addEventListener("click", e => {
            modalOff()
        })

        modal.addEventListener("click", e => {
            const evTarget = e.target
            if (evTarget.classList.contains("modal-overlay")) {
                modalOff()
            }
        })

        window.addEventListener("keyup", e => {
            if (isModalOn() && e.key === "Escape") {
                modalOff()
            }
        })

        const modal2 = document.getElementById("modal2");

        function modalOn2() {
            modal2.style.display = "flex";
        }

        function isModalOn2() {
            return modal2.style.display === "flex";
        }

        function modalOff2() {
            modal2.style.display = "none";
        }

        const btnModal2 = document.getElementById("btn-modal2");
        btnModal2.addEventListener("click", e => {
            modalOn2();
        });

        const closeBtn2 = modal2.querySelector(".close-area");
        closeBtn2.addEventListener("click", e => {
            modalOff2();
        });

        modal2.addEventListener("click", e => {
            const evTarget = e.target;
            if (evTarget.classList.contains("modal-overlay")) {
                modalOff2();
            }
        });

        window.addEventListener("keyup", e => {
            if (isModalOn2() && e.key === "Escape") {
                modalOff2();
            }
        });
	
	    // 사용자 정보 섹션을 보여주는 함수
			function showUserInfoSection(userProfile) {
			    // 사용자 정보 업데이트
			    var textHighlight = document.querySelector(".text-highlight");
			    var accountSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.account}']");
			    var emailSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.email}']");
			    var nameSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.name}']");
			    var phoneSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.phone}']");
			    var ageSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.age}']");
			    var addressSpan = document.querySelector(".user-info span[th\\:text='#{userProfile.address}']");
			
			    if (textHighlight && accountSpan && emailSpan && nameSpan && phoneSpan && ageSpan && addressSpan) {
			        textHighlight.innerText = userProfile.name + '님의 프로필';
			        accountSpan.innerText = userProfile.account;
			        emailSpan.innerText = userProfile.email;
			        nameSpan.innerText = userProfile.name;
			        phoneSpan.innerText = userProfile.phone;
			        ageSpan.innerText = userProfile.age;
			        addressSpan.innerText = userProfile.address;
			    } else {
			        console.error("One or more elements not found.");
			    }
			}



	
	    // 주문 정보 테이블을 보여주는 함수
	    function showOrderDetailsTable(orderList) {
	        console.log("Table Shown!");
	        createTable(orderList);
	        orderDetailsTable.style.display = "block";
	        userInfoSection.style.display = "none";
	    }

			// xhrButton0 클릭 이벤트 핸들러
			xhrButton0.addEventListener("click", function () {
                $.ajax({
                    url: "/user/profileList",
                    type: "GET",
                    dataType: "json",
                    success: function (userProfile) {
                        if (userProfile != null) {
                            showUserInfoSection(userProfile);
                            userInfoSection.style.display = "block";
                             $("#orderWrap").hide();
                        } else {
                            console.error("Failed to fetch user info");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching user info:", error);
                    }
                });
            });
			
			
	

			   $(document).ready(function () {
                xhrButton.addEventListener("click", function () {
                    $.ajax({
                        url: "/user/orderList",
                        type: "GET",
                        dataType: "json",
                        success: function (orderList) {
                            if (orderList != null) {
                                showOrderList(orderList);
                                userInfoSection.style.display = "none";
                                 $("#orderWrap").show();
                            } else {
                                console.error("Failed to fetch order list");
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Error fetching order list:", error);
                        }
                    });
                });

            // 주문 목록을 페이지에 표시하는 함수
            function showOrderList(orderList) {
                var orderWrap = $("#orderWrap");
                orderWrap.empty();

                for (var i = 0; i < orderList.length; i++) {
                    var order = orderList[i];

                      var orderHtml = '<div class="orderDiv">' +
				            '<div class="getOrderDetailBox">' +
				                '<div class="orderDateBox">' + order.orderDate + ' 주문</div>' +
				            '</div>' +
				            '<div class="orderDetailDiv">';
				
				        // 주문 상태에 따른 텍스트 결정
				        var orderStatusText = '';
				        switch (order.orderState) {
				            case 0:
				                orderStatusText = '주문 완료';
				                break;
				            case 1:
				                orderStatusText = '배송 예정';
				                break;
				            case 2:
				                orderStatusText = '주문 취소';
				                break;
				            case 3:
				                orderStatusText = '배송 완료';
				                break;
				            default:
				                orderStatusText = '알 수 없는 상태';
				        }
				
				        // 주문 상태 텍스트 추가
				        orderHtml += '<div class="stateText">' + orderStatusText + '</div>';
				
				        orderHtml += '<div class="orderDetailInfoDiv">' +
				                        '<img src="data:' + order.contractList[0].product.imageType + ';base64,' + order.contractList[0].product.imageFile + '" alt="productImage" class="productImage">' +
				                        '<div class="productText">' +
				                            '<div class="ModelClass">' + order.contractList[0].product.productModel + '</div>' +
				                            '<div class="modelName">';
				
				        // 주문 사이즈에 따라 텍스트 결정
				        if (order.orderSize != 0) {
				            orderHtml += order.contractList[0].product.productName + ' 외 ' + order.orderSize;
				        } else {
				            orderHtml += order.contractList[0].product.productName;
				        }
				
				        orderHtml += '</div>' +
				                        '<hr>' +
				                        '<div>';
				
				        // 주문 가격에 따라 텍스트 결정
				        if (order.orderPrice != 0) {
				            orderHtml += '총 결제액 : <span class="spanText">' + order.orderPrice + '원</span>';
				        }
				        orderHtml += '</div>' +
				                        '<div>';
				
				        // 렌탈 가격에 따라 텍스트 결정
				        if (order.rentalPrice != 0) {
				            orderHtml += '월 렌탈료 : <span class="spanText">월 ' + order.rentalPrice + '원</span>';
				        }
				        orderHtml += '</div>' +
				                        '</div>' +
				                    '</div>' +
				                    '<div class="rightBox">' +
				                        '<div class="rightDetailButtonDiv">' +
				                            '<form method="get" action="/user/orderDetail">' +
				                                '<input type="hidden" value="' + order.orderId + '" name="orderId">' +
				                                '<button class="orderDetailButton">주문 상세조회</button>' +
				                            '</form>' +
				                        '</div>' +
				                    '</div>' +
				                '</div>' +
				            '</div>';

                    orderWrap.append(orderHtml);
                }
            }
        });
});
    </script>

</body>
</html>